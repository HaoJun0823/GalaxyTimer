name: Build GalaxyTimer (Win10/11, Python 3.11, slim + TTS + pyscript)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 90

    env:
      PYTHON_VERSION: '3.11'
      ENTRY: 'pyscript/galaxytimer.py'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build deps
        shell: pwsh
        env:
          PIP_DISABLE_PIP_VERSION_CHECK: "1"
        run: |
          python -m pip install --upgrade pip setuptools wheel
          # 必需依赖：GUI/TTS/键盘/COM
          python -m pip install pyinstaller PySide6 pyttsx3 keyboard comtypes pywin32
          if (Test-Path "requirements.txt") {
            python -m pip install -r requirements.txt
          } else {
            Write-Host "No requirements.txt found. Skipping."
          }
          $pyside_loc = (python -c "import pathlib, PySide6; print(pathlib.Path(PySide6.__file__).resolve())")
          Write-Host "PySide6 at: $pyside_loc"
      - name: Inject build salt (optional)
        shell: pwsh
        run: |
          if (Test-Path $env:ENTRY) {
            $bytes = New-Object byte[] 12
            (New-Object System.Security.Cryptography.RNGCryptoServiceProvider).GetBytes($bytes)
            $salt = [Convert]::ToBase64String($bytes).Replace('/','_').Replace('+','-').Replace('=','')
            if ($salt.Length -gt 16) { $salt = $salt.Substring(0,16) }
            "BUILD_SALT=$salt" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
            $content = Get-Content $env:ENTRY -Raw
            if ($content -match "__BUILD_SALT__") {
              ($content -replace "__BUILD_SALT__", $salt) | Set-Content $env:ENTRY -Encoding UTF8
              Write-Host "Injected salt into entry."
            } else {
              Write-Host "No __BUILD_SALT__ placeholder - skip."
            }
          } else {
            Write-Error "Entry not found: $env:ENTRY"
            exit 1
          }
      - name: Locate Qt plugin folders via QLibraryInfo (with fallback)
        id: qtpaths
        shell: pwsh
        run: |
          # 先用 QLibraryInfo 获取官方插件目录（PowerShell 一行式）
          $plugins = (python -c "from PySide6.QtCore import QLibraryInfo; from pathlib import Path; print(Path(QLibraryInfo.path(QLibraryInfo.LibraryPath.PluginsPath)))").Trim()
          Write-Host "QLibraryInfo PluginsPath -> $plugins"
          $candidates = @()
          if ($plugins) {
            $candidates += (Join-Path $plugins "platforms")
            $candidates += (Join-Path $plugins "imageformats")
          }
          # 回退：PySide6 安装根目录下的常见结构
          $pysideRoot = (python -c "import pathlib, PySide6; print(pathlib.Path(PySide6.__file__).resolve().parent)").Trim()
          if ($pysideRoot) {
            $candidates += (Join-Path (Join-Path $pysideRoot 'Qt\plugins') 'platforms')
            $candidates += (Join-Path (Join-Path $pysideRoot 'Qt\plugins') 'imageformats')
            $candidates += (Join-Path (Join-Path $pysideRoot 'plugins') 'platforms')
            $candidates += (Join-Path (Join-Path $pysideRoot 'plugins') 'imageformats')
          }
          # 去重并挑选最终的 platforms / imageformats
          $platPath = $null; $imgPath = $null
          foreach ($path in $candidates | Select-Object -Unique) {
            if (-not (Test-Path $path)) { continue }
            if ($path -like "*\platforms")   { if (-not $platPath) { $platPath = $path } }
            if ($path -like "*\imageformats"){ if (-not $imgPath)  { $imgPath  = $path } }
          }
          if (-not $platPath) { Write-Error "Qt platforms not found in candidates."; exit 1 }
          if (-not $imgPath)  { Write-Error "Qt imageformats not found in candidates."; exit 1 }
          "QTP_PLAT=$platPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "QTP_IMG=$imgPath"  | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "Qt plugins -> platforms:  $platPath"
          Write-Host "Qt plugins -> imageformats: $imgPath"
      - name: Build EXE with PyInstaller (slim + TTS deps + pyscript data)
        shell: pwsh
        run: |
          # 自动图标（存在才用；按你的要求不打包 resources/）
          $icon = $null
          if (Test-Path ".\resources\icon\icon.ico") { $icon = ".\resources\icon\icon.ico" }
          elseif (Test-Path ".\Resources\icon\icon.ico") { $icon = ".\Resources\icon\icon.ico" }
          $args = @(
            "--noconfirm","--clean","-F","-w",
            # ====== 语音（SAPI5）关键依赖 ======
            "--hidden-import","pyttsx3.drivers",
            "--hidden-import","pyttsx3.drivers.sapi5",
            "--hidden-import","win32com.client",
            "--hidden-import","comtypes",
            "--hidden-import","comtypes.gen",
            "--collect-submodules","comtypes",
            "--collect-data","pyttsx3",
            # ====== PySide6：最小 Widgets 集 ======
            "--collect-submodules","PySide6.QtCore",
            "--collect-submodules","PySide6.QtGui",
            "--collect-submodules","PySide6.QtWidgets",
            # 明确排除未用的大模块（用到再移除此行）
            "--exclude-module","PySide6.QtWebEngineCore",
            "--exclude-module","PySide6.QtWebEngineWidgets",
            "--exclude-module","PySide6.QtWebEngineQuick",
            "--exclude-module","PySide6.QtQml",
            "--exclude-module","PySide6.QtQuick",
            "--exclude-module","PySide6.QtPdf",
            "--exclude-module","PySide6.QtPdfWidgets",
            "--exclude-module","PySide6.QtCharts",
            "--exclude-module","PySide6.QtDataVisualization",
            "--exclude-module","PySide6.QtLocation",
            "--exclude-module","PySide6.QtPositioning",
            "--exclude-module","PySide6.QtMultimedia"
            # "--exclude-module","PySide6.QtNetwork"  # 若代码确实用到网络，请删掉此行
          )
          # 最小 Qt 插件（来自前一步解析出路径）
          $args += @("--add-data","$env:QTP_PLAT;PySide6\plugins\platforms")
          $args += @("--add-data","$env:QTP_IMG;PySide6\plugins\imageformats")
          # ====== 按你的要求：pyscript 整体作为数据打入 ======
          $args += @("--add-data",".\pyscript;pyscript")
          if ($icon) { $args += @("--icon",$icon) }
          # 不打包 resources/ 目录（按你的要求）
          $args += $env:ENTRY
          Write-Host "pyinstaller $($args -join ' ')"
          pyinstaller @args
          if ($LASTEXITCODE -ne 0) { Write-Error "PyInstaller build failed."; exit 1 }
      - name: Rename and upload
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path .\dist -Filter *.exe -File | Select-Object -First 1
          if ($exe) {
            Move-Item -Force $exe.FullName .\GalaxyTimer.exe
            Write-Host "Executable built: GalaxyTimer.exe"
          } else {
            Write-Error "Executable not found!"
            exit 1
          }
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: GalaxyTimer-exe
          path: GalaxyTimer.exe
