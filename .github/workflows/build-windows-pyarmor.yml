name: Build GalaxyTimer (PyInstaller with PyArmor)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 90
    env:
      PYTHON_VERSION: '3.11'
      ENTRY: pyscript/galaxytimer.py

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build tools and dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install pyinstaller pyarmor==8.1.0
          # 安装requirements.txt中所有需依赖的包
          if (-Not (Test-Path "requirements.txt")) { 
            Write-Error "requirements.txt not found in the repository root."
            exit 1
          }
          python -m pip install -r requirements.txt

      - name: List Installed Packages
        shell: pwsh
        run: |
          echo "Installed Packages:"
          pip list

      - name: Prepare Build Source and Resources
        shell: pwsh
        run: |
          Remove-Item -Force -ErrorAction SilentlyContinue .\GalaxyTimer.exe
          Remove-Item -Recurse -Force -ErrorAction SilentlyContinue .\build_src, .\obf, .\dist, .\build
          New-Item -ItemType Directory -Force -Path build_src | Out-Null
          Copy-Item -Recurse -Force -Path .\pyscript -Destination .\build_src\pyscript
          $srcFolders = @("logic", "core", "widgets")
          foreach ($folder in $srcFolders) {
            if (Test-Path ".\pyscript\$folder") {
              Copy-Item -Recurse -Force -Path ".\pyscript\$folder" -Destination ".\build_src\pyscript\$folder"
            } else {
              Write-Host "Warning: Folder pyscript\$folder not found."
            }
          }
      
      - name: Inject Build Salt
        shell: pwsh
        run: |
          $bytes = New-Object byte[] 12
          $rng = New-Object System.Security.Cryptography.RNGCryptoServiceProvider
          $rng.GetBytes($bytes)
          $salt = [System.Convert]::ToBase64String($bytes) -replace '/', '_' -replace '\+', '-' -replace '=', ''
          if ($salt.Length -gt 16) { $salt = $salt.Substring(0,16) }
          Write-Host "Generated SALT: $salt"
          Add-Content -Path $env:GITHUB_ENV -Value "BUILD_SALT=$salt"
          $entryPath = Join-Path -Path (Get-Location) -ChildPath $env:ENTRY
          (Get-Content $entryPath -Raw) -replace "__BUILD_SALT__", $salt | Set-Content $entryPath -Encoding UTF8

      - name: Obfuscate with PyArmor
        shell: pwsh
        run: |
          python -m pyarmor-8 gen --with-loader --output .\obf .\build_src
          if (-Not (Test-Path ".\obf")) {
            Write-Error "Obfuscation directory was not created."
            exit 1
          }
          Copy-Item -Recurse -Force .\obf\* .\dist

      - name: Check Obfuscation Output
        shell: pwsh
        run: |
          Write-Host "Checking contents of the obfuscation output directory:"
          Get-ChildItem -Path .\dist

      - name: Validate Exe Creation via PyInstaller
        shell: pwsh
        run: |
          python -m pyinstaller --noconfirm --windowed --onefile --icon=.\\resources\\icon\\icon.ico --distpath .\\dist .\\obf\\pyscript\\galaxytimer.py

      - name: Rename and Publish Exe
        shell: pwsh
        run: |
          $exePath = Join-Path -Path (Get-Location) -ChildPath "dist\galaxytimer.exe"
          if (Test-Path $exePath) {
            Move-Item -Force $exePath .\GalaxyTimer.exe
            Write-Host "Moved to GalaxyTimer.exe"
          } else {
            Write-Error "GalaxyTimer.exe not found in the dist directory."
            exit 1
          }

      - name: Clean Up
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force -ErrorAction SilentlyContinue .\dist, .\build
          Get-ChildItem -Path . -Filter "*.spec" -File | ForEach-Object { Remove-Item -Force $_.FullName }

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GalaxyTimer-exe
          path: GalaxyTimer.exe
