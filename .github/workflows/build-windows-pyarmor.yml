      - name: Build EXE with PyInstaller (data-mode + TTS deps + pyscript data)
        shell: pwsh
        run: |
          $icon = $null
          if (Test-Path ".\resources\icon\icon.ico") { $icon = ".\resources\icon\icon.ico" }
          elseif (Test-Path ".\Resources\icon\icon.ico") { $icon = ".\Resources\icon\icon.ico" }

          $args = @(
            "--noconfirm","--clean","-F","-w",

            # ====== 语音（SAPI5）关键依赖 ======
            "--hidden-import","pyttsx3.drivers",
            "--hidden-import","pyttsx3.drivers.sapi5",
            "--hidden-import","win32com.client",
            "--hidden-import","comtypes",
            "--hidden-import","comtypes.gen",
            "--collect-submodules","comtypes",
            "--collect-data","pyttsx3",

            # ====== PySide6：最小 Widgets 集 ======
            "--collect-submodules","PySide6.QtCore",
            "--collect-submodules","PySide6.QtGui",
            "--collect-submodules","PySide6.QtWidgets",

            # 明确排除未用大模块（用到再移除此行）
            "--exclude-module","PySide6.QtWebEngineCore",
            "--exclude-module","PySide6.QtWebEngineWidgets",
            "--exclude-module","PySide6.QtWebEngineQuick",
            "--exclude-module","PySide6.QtQml",
            "--exclude-module","PySide6.QtQuick",
            "--exclude-module","PySide6.QtPdf",
            "--exclude-module","PySide6.QtPdfWidgets",
            "--exclude-module","PySide6.QtCharts",
            "--exclude-module","PySide6.QtDataVisualization",
            "--exclude-module","PySide6.QtLocation",
            "--exclude-module","PySide6.QtPositioning",
            "--exclude-module","PySide6.QtMultimedia",

            # ====== Qt 插件（最小必需） ======
            "--add-data","$env:QTP_PLAT;PySide6\plugins\platforms",
            "--add-data","$env:QTP_IMG;PySide6\plugins\imageformats",

            # ====== 关键：把整个 pyscript 作为数据打入 ======
            "--add-data",".\pyscript;pyscript"
            # ↑ 注意：这里不要加逗号
          )

          if ($icon) { $args += @("--icon",$icon) }

          # ====== （可选）字节码加密密钥（仅 PyInstaller 5.x 可用；如不想加盐，删掉这一行） ======
          $args += @("--key","$env:PYI_KEY")

          # 按你的要求：不把 resources/ 打进包里；以入口脚本构建
          $args += $env:ENTRY

          Write-Host "pyinstaller $($args -join ' ')"
          pyinstaller @args
          if ($LASTEXITCODE -ne 0) { Write-Error "PyInstaller build failed."; exit 1 }
