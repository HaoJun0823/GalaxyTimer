name: build-windows-pyarmor

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip setuptools wheel
          if (Test-Path "requirements.txt") {
            python -m pip install -r requirements.txt
          }
          # 只装 PyInstaller / PyArmor，不装 pywin32
          python -m pip install pyinstaller pyarmor

      - name: Patch runtime CWD (fix resources path)
        shell: pwsh
        run: |
          $p = "pyscript/galaxytimer.py"
          if (-not (Test-Path $p)) { Write-Host "galaxytimer.py not found, skip patch"; exit 0 }
          $c = Get-Content $p -Raw -Encoding UTF8

          if ($c -match 'os\.chdir\(cur_path\)') {
            Write-Host "CWD patch already exists. Skipping."
          } else {
            $pattern = 'cur_path\s*=\s*os\.getcwd\(\)'
            $replacement = @'
if getattr(sys, "frozen", False):
    cur_path = os.path.dirname(sys.executable)
else:
    cur_path = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
os.chdir(cur_path)
'@
            $new = [regex]::Replace($c, $pattern, $replacement)
            Set-Content -Path $p -Value $new -Encoding UTF8
            Write-Host "Patched galaxytimer.py to set CWD to program dir."
          }

      # （可选）如需 PyArmor 混淆，可开启以下两行：
      # - name: Obfuscate with PyArmor (optional)
      #   run: pyarmor gen -O obf -r pyscript

      - name: Generate random salt for PyInstaller --key
        shell: pwsh
        run: |
          $bytes = New-Object byte[] 12
          (New-Object System.Security.Cryptography.RNGCryptoServiceProvider).GetBytes($bytes)
          $salt = [Convert]::ToBase64String($bytes).Replace('/','_').Replace('+','-').Replace('=','')
          if ($salt.Length -gt 16) { $salt = $salt.Substring(0,16) }
          "BUILD_SALT=$salt" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "Random salt generated."

      - name: Resolve KEY (prefer secrets, else random)
        shell: pwsh
        run: |
          if ("${{ secrets.PYINSTALLER_KEY }}" -ne "") {
            $env:PYI_KEY = "${{ secrets.PYINSTALLER_KEY }}"
            Write-Host "Using PYINSTALLER_KEY from secrets."
          } else {
            $env:PYI_KEY = "$env:BUILD_SALT"
            Write-Host "Using generated random salt as key."
          }
          "PYI_KEY=$($env:PYI_KEY)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Build EXE with PyInstaller (salted)
        shell: pwsh
        run: |
          $entry = "pyscript/galaxytimer.py"
          if (Test-Path "obf/pyscript/galaxytimer.py") { $entry = "obf/pyscript/galaxytimer.py" }  # 若启用 PyArmor 则使用混淆后的入口

          $args = @(
            "--noconfirm","--clean","-F","-w",

            # 语音：SAPI5 & comtypes（不携带 win32com）
            "--hidden-import","pyttsx3.drivers",
            "--hidden-import","pyttsx3.drivers.sapi5",
            "--hidden-import","comtypes",
            "--hidden-import","comtypes.gen",
            "--collect-submodules","comtypes",
            "--collect-data","pyttsx3",

            # PySide6：核心模块 + Svg/Xml
            "--collect-submodules","PySide6.QtCore",
            "--collect-submodules","PySide6.QtGui",
            "--collect-submodules","PySide6.QtWidgets",
            "--collect-submodules","PySide6.QtSvg",
            "--collect-submodules","PySide6.QtXml",

            # 体积控制：明确排除未用 webengine
            "--exclude-module","PySide6.QtWebEngineCore",
            "--exclude-module","PySide6.QtWebEngineWidgets",
            "--exclude-module","PySide6.QtWebEngineQuick",

            # 真正加盐
            "--key","$env:PYI_KEY"
          )

          if (Test-Path ".\resources\icon\icon.ico") {
            $args += @("--icon",".\resources\icon\icon.ico")
          }

          # 不把 resources/ 打进包里（按你的要求）
          $args += $entry

          pyinstaller @args

      - name: UPX compress (optional)
        shell: pwsh
        run: |
          choco install upx -y
          $upx = "C:\ProgramData\chocolatey\lib\upx\tools\upx.exe"
          if (Test-Path $upx) {
            & $upx --best --lzma dist\*.exe
          } else {
            Write-Host "UPX not found, skip."
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: GalaxyTimer_Windows
          path: dist/*.exe
