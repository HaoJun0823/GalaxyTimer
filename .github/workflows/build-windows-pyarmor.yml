name: Build GalaxyTimer (Full Windows support, Python 3.11)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 90

    env:
      PYTHON_VERSION: '3.11'
      ENTRY: 'pyscript/galaxytimer.py'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Upgrade pip & install dependencies
        shell: pwsh
        env:
          PIP_DISABLE_PIP_VERSION_CHECK: "1"
        run: |
          python -m pip install --upgrade pip setuptools wheel
          # 安装项目依赖及构建工具
          python -m pip install pyinstaller pyttsx3 PySide6 keyboard comtypes pywin32
          if (Test-Path "requirements.txt") {
            python -m pip install -r requirements.txt
          } else {
            Write-Host "No requirements.txt found. Skipping extra deps."
          }

      - name: Inject build salt (optional)
        shell: pwsh
        run: |
          $bytes = New-Object byte[] 12
          (New-Object System.Security.Cryptography.RNGCryptoServiceProvider).GetBytes($bytes)
          $salt = [Convert]::ToBase64String($bytes).Replace('/','_').Replace('+','-').Replace('=','')
          if ($salt.Length -gt 16) { $salt = $salt.Substring(0,16) }
          "BUILD_SALT=$salt" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "Build salt: $salt"

          if (Test-Path $env:ENTRY) {
            $content = Get-Content $env:ENTRY -Raw
            if ($content -match "__BUILD_SALT__") {
              $content = $content -replace "__BUILD_SALT__", $salt
              $content | Set-Content $env:ENTRY -Encoding UTF8
              Write-Host "Injected salt into entry script."
            } else {
              Write-Host "No __BUILD_SALT__ placeholder detected, skip."
            }
          }

      - name: Build EXE with PyInstaller
        shell: pwsh
        run: |
          # 自动检测图标
          $iconCandidates = @(
            ".\resources\icon\icon.ico",
            ".\Resources\icon\icon.ico"
          )
          $icon = $null
          foreach ($p in $iconCandidates) { if (Test-Path $p) { $icon = $p; break } }

          # 构建参数
          $args = @(
            "--noconfirm",
            "--clean",
            "-F",
            "-w",
            "--paths", ".\pyscript",
            "--hidden-import", "pyttsx3.drivers",
            "--hidden-import", "pyttsx3.drivers.sapi5",
            "--hidden-import", "win32com.client",
            "--hidden-import", "comtypes",
            "--collect-all", "PySide6",
            "--collect-submodules", "PySide6",
            "--collect-binaries", "PySide6",
            "--collect-data", "PySide6",
            "--collect-all", "pyttsx3",
            "--collect-all", "keyboard"
          )

          if ($icon) { $args += @("--icon", $icon) }

          # 加入资源文件夹
          if (Test-Path ".\resources") { $args += @("--add-data", "resources;resources") }
          if (Test-Path ".\Resources") { $args += @("--add-data", "Resources;Resources") }

          # 加入 pyscript 子目录
          $subDirs = @("logic","core","widgets","assets","ui","data","images","icons","fonts","themes")
          foreach ($d in $subDirs) {
            $p = Join-Path ".\pyscript" $d
            if (Test-Path $p) { $args += @("--add-data", "$p;$d") }
          }

          $args += $env:ENTRY
          Write-Host "Running PyInstaller..."
          pyinstaller @args
          if ($LASTEXITCODE -ne 0) { Write-Error "PyInstaller failed."; exit 1 }

      - name: Rename and upload
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path .\dist -Filter *.exe -File | Select-Object -First 1
          if ($exe) {
            Move-Item -Force $exe.FullName .\GalaxyTimer.exe
            Write-Host "Executable built: GalaxyTimer.exe"
          } else {
            Write-Error "Executable not found!"
            exit 1
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: GalaxyTimer-exe
          path: GalaxyTimer.exe
